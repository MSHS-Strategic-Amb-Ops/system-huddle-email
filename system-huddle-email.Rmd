---
title: "system-huddle-email"
output: html_document
---


```{r setup, include=FALSE}

library(blastula)
library(rmarkdown)
library(here)
library(glue)
library(lubridate)
```


```{r processing, include = FALSE}

# source("Scripts/pull_and_process_monthly.R", local = knitr::knit_global())
```

```{r pressure, echo=FALSE}

sending_date <-
  paste0(
    format(Sys.Date() %m+% days(1), "%B "),
    format(Sys.Date() %m+% days(1), "%d") %>% as.numeric(),
    ", ",
    format(Sys.Date() %m+% days(1), "%Y")
  )


email_credential_location <- "/SharedDrive/deans/Presidents/HSPI-PM/Operations Analytics and Optimization/Administrative/Workgroups/R Workbench/Working Area/Data Connections/email_creds"
cc_list <- c("soyoun.kweon@mssm.edu")
send_list <- c("soyoun.kweon@mssm.edu")
email_subject <- glue("System Huddle Report - Week of {sending_date}")

sinai_logo <- add_image(file = "www/Mount_Sinai_Logo_H.png",
                        width = 300)

# Generate the footer text
footer_text <- glue("System Huddle Report for the Week of {sending_date}.\n This is auto-generated email.")



##Use blastula to construct email to send
compose_email(header = sinai_logo,
              body = render_email("Scripts/email_body.Rmd")$html_html,
              footer = footer_text) %>%
  # add_attachment(
  #   file = save_compressed_file_path,
  #   filename = paste0("Oncology Arrived Data ", month_year, ".zip")) %>%
  purrr::list_modify(html_str =
                       .$html_str %>%
                       stringr::str_replace_all(pattern = "(?i)#f6f6f6",
                                                replacement = "#FFFFFF")) %>%
  smtp_send(
    from = "soyoun.kweon@mssm.edu",
    to = send_list,
    cc = cc_list,
    credentials = creds_file(file = email_credential_location),
    subject = email_subject
  ) 

```